<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login Successful - SecurePass Studio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/auth.css">
  <style>
    .oauth-success {
      text-align: center;
    }
    .oauth-success .spinner-large {
      width: 48px;
      height: 48px;
      border: 3px solid var(--glass-border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--space-lg);
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .success-icon {
      font-size: 3rem;
      margin-bottom: var(--space-md);
    }
  </style>
</head>
<body>
  <!-- Animated Background Orbs -->
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>

  <div class="auth-container">
    <a href="index.html" class="auth-logo">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="11" width="18" height="11" rx="2"/>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
      </svg>
      <span>SecurePass</span>
    </a>

    <div class="auth-card oauth-success">
      <div id="loadingState">
        <div class="spinner-large"></div>
        <h1>Completing Login...</h1>
        <p class="auth-subtitle">Please wait while we set up your session</p>
      </div>
      
      <div id="successState" style="display: none;">
        <div class="success-icon">✅</div>
        <h1>Login Successful!</h1>
        <p class="auth-subtitle">Redirecting to your dashboard...</p>
      </div>
      
      <div id="errorState" style="display: none;">
        <div class="success-icon">❌</div>
        <h1>Login Failed</h1>
        <p class="auth-subtitle" id="errorMessage">Something went wrong. Please try again.</p>
        <a href="login.html" class="btn primary auth-btn" style="margin-top: var(--space-lg);">
          Back to Login
        </a>
      </div>
    </div>
  </div>

  <script src="js/api.js"></script>
  <script>
    // Handle OAuth callback
    async function handleOAuthCallback() {
      const loadingState = document.getElementById('loadingState');
      const successState = document.getElementById('successState');
      const errorState = document.getElementById('errorState');
      const errorMessage = document.getElementById('errorMessage');
      
      // Check for error in URL params
      const urlParams = new URLSearchParams(window.location.search);
      const error = urlParams.get('error');
      
      if (error) {
        loadingState.style.display = 'none';
        errorState.style.display = 'block';
        errorMessage.textContent = error === 'oauth_failed' 
          ? 'OAuth authentication failed. Please try again.'
          : error;
        return;
      }
      
      try {
        // Try to refresh token (the httpOnly cookie should be set by the backend)
        const result = await window.SecurePassAPI.refreshAccessToken();
        
        if (result && result.accessToken) {
          // Success!
          loadingState.style.display = 'none';
          successState.style.display = 'block';
          
          // Store user info in session storage for the dashboard
          if (result.user) {
            sessionStorage.setItem('securepass_user', JSON.stringify(result.user));
          }
          
          // Redirect to dashboard after a brief delay
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 1500);
        } else {
          throw new Error('No access token received');
        }
      } catch (err) {
        console.error('OAuth callback error:', err);
        loadingState.style.display = 'none';
        errorState.style.display = 'block';
        errorMessage.textContent = err.message || 'Authentication failed. Please try again.';
      }
    }
    
    // Run on page load
    document.addEventListener('DOMContentLoaded', handleOAuthCallback);
  </script>
</body>
</html>
