generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String?  @unique
  passwordHash String?  // null for OAuth-only users
  name         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Per-user encryption key wrapped with server MASTER_KEY (AES-256-GCM)
  wrappedKey String?

  // User settings
  settings   UserSettings?

  oauthProviders  OAuthProvider[]
  vaultEntries    VaultEntry[]
  refreshTokens   RefreshToken[]
  collections     Collection[]
  tags            Tag[]
  auditLogs       AuditLog[]
  secureNotes     SecureNote[]
  sharedLinks     SharedLink[]
  emergencyAccess EmergencyAccess[]
}

model UserSettings {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  // Clipboard settings
  clipboardClearSeconds Int     @default(15)
  revealTimeSeconds     Int     @default(10)

  // Security settings
  requireMasterPassword Boolean @default(false)
  biometricEnabled      Boolean @default(false)

  // Notification settings
  breachMonitoring      Boolean @default(false)
  rotationReminders     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OAuthProvider {
  id           String  @id @default(uuid())
  provider     String  // 'google' or 'github'
  providerId   String  // unique ID from the OAuth provider
  accessToken  String? 
  refreshToken String? 

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@unique([provider, providerId])
}

// Collections (Folders) for organizing entries
model Collection {
  id    String @id @default(uuid())
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  name        String
  description String?
  icon        String? // emoji or icon name
  color       String? // hex color

  entries VaultEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// Tags for filtering
model Tag {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  name  String
  color String? // hex color

  entries VaultEntryTag[]

  createdAt DateTime @default(now())

  @@unique([userId, name])
  @@index([userId])
}

// Many-to-many relationship for VaultEntry and Tag
model VaultEntryTag {
  id      String     @id @default(uuid())
  entry   VaultEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  entryId String
  tag     Tag        @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId   String

  @@unique([entryId, tagId])
}

model VaultEntry {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  // Organization
  collection   Collection? @relation(fields: [collectionId], references: [id], onDelete: SetNull)
  collectionId String?

  // Core fields
  title    String
  username String
  site     String?
  notes    String?

  // Encrypted password data (AES-256-GCM)
  passwordCiphertext String
  iv                 String
  tag                String

  // New features
  isFavorite   Boolean  @default(false)
  isPinned     Boolean  @default(false)
  strength     Int?     // 0-4 strength score
  lastUsedAt   DateTime?
  rotateAt     DateTime? // reminder to rotate password

  // 2FA Support (encrypted TOTP secret or backup codes)
  totpSecretCiphertext String?
  totpSecretIv         String?
  totpSecretTag        String?

  // Metadata
  tags       VaultEntryTag[]
  sharedLinks SharedLink[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([collectionId])
  @@index([isFavorite])
}

model RefreshToken {
  id        String   @id @default(uuid())
  tokenHash String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  revoked   Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([tokenHash])
  @@index([userId])
}

// Audit Log for security tracking
model AuditLog {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  action    String    // 'reveal', 'copy', 'create', 'update', 'delete', 'login', 'export', 'share'
  entryId   String?   // optional reference to vault entry
  entryTitle String?  // store title for deleted entries
  ipAddress String?
  userAgent String?
  details   String?   // JSON string with additional info

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

// Secure Notes (encrypted documents/notes)
model SecureNote {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  title String

  // Encrypted content (AES-256-GCM)
  contentCiphertext String
  contentIv         String
  contentTag        String

  // Optional attachment (small encrypted blob, max 1MB)
  attachmentName       String?
  attachmentCiphertext String?
  attachmentIv         String?
  attachmentTag        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// Shared Links for secure one-time sharing
model SharedLink {
  id     String     @id @default(uuid())
  entry  VaultEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  entryId String
  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  // Secure token for access
  tokenHash String @unique

  // Access control
  maxViews     Int       @default(1)
  viewCount    Int       @default(0)
  expiresAt    DateTime
  accessedAt   DateTime?
  accessorIp   String?

  // What to share
  includePassword Boolean @default(true)
  includeNotes    Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([tokenHash])
  @@index([entryId])
}

// Emergency Access for inheritance/recovery
model EmergencyAccess {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String // vault owner

  // Trusted contact
  trusteeName  String
  trusteeEmail String

  // Access settings
  waitDays     Int      @default(7) // days to wait before access granted
  status       String   @default("pending") // 'pending', 'approved', 'denied', 'expired'
  requestedAt  DateTime?
  grantedAt    DateTime?

  // Encrypted access key (wrapped with trustee's key if they have account)
  encryptedAccessKey String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([trusteeEmail])
}
